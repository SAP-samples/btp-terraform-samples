'use strict';

const xsrfTokenHandler = require('./xsrf-token-handler');
const dynamicRoutingUtils = require('../utils/dynamic-routing-utils');
const urijs = require('urijs');
const urlUtils = require('../utils/url-utils');

module.exports = function welcomePage(req, res, next) {
  let welcomeFile = req.routerConfig.appConfig.welcomeFile;
  let url = dynamicRoutingUtils.getCoreUrl (req);
  let newWelcomeFile;
  let newUrl;
  if (welcomeFile && /^\/(\?.*$)?$/.test(url)) {
    let tracer = req.loggingContext.getTracer(__filename);

    if (welcomeFile[0] !== '/') {
      welcomeFile = '/' + welcomeFile;
    }

    let dynamicIDP = urlUtils.getQueryParam(req, 'sap_idp', false);
    if (dynamicIDP) {
      welcomeFile = welcomeFile + '/?sap_idp=' + dynamicIDP;
    }

    tracer.info('x-forwarded-path header: "%s" ', req.headers['x-forwarded-path']);

    if (req.headers['x-forwarded-path']) {
      let parsedXForwardedPath = urijs.parse(req.headers['x-forwarded-path']);
      let prefix = parsedXForwardedPath.path.replace(/\/+$/, ''); // remove trailing slash
      prefix = parsedXForwardedPath.path.startsWith('/') ? prefix : '/' + prefix; // adding leading slash if not present
      newWelcomeFile = prefix + welcomeFile;
      newWelcomeFile = parsedXForwardedPath.query ? newWelcomeFile + '?' + parsedXForwardedPath.query : newWelcomeFile;
    }

    tracer.info('Incoming request: "%s" will use welcome page "%s"', req.url, newWelcomeFile);
    newUrl = newWelcomeFile ? newWelcomeFile :  dynamicRoutingUtils.getFullUrl (req, welcomeFile);

    if (!xsrfTokenHandler.isTokenFetchRequest(req)) {
      res.writeHead(302, { Location: newUrl });
      return res.end();
    }

    req.url = newUrl;
  }
  next();
};
