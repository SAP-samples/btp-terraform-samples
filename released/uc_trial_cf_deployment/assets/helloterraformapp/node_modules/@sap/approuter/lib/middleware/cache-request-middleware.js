'use strict';

const deepmerge = require('deepmerge');
const sessionExt = require('../utils/session-ext');

module.exports = function cacheRequestData (req, res, next) {

  if (!req.toBeCachedOnSession || !req.toBeCachedOnSession.user) {
    return next ();
  }
  if (req.session && req.session.user) {
    let toBeCachedOnSession = Object.assign({}, req.toBeCachedOnSession);
    sessionExt.update(req.session, function(session) {
      if (session) {
        session.user = deepmerge(session.user, toBeCachedOnSession.user);
      }
    });
  }

  delete req.toBeCachedOnSession;
  next ();
};