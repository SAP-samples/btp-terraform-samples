'use strict';
const vcapUtils = require('../utils/vcap-utils');
const subscriptionUtils = require('../utils/subscription-utils');
const SAAS_REGISTRY = 'saas-registry';
const SUBSCRIPTION_MANAGER = 'subscription-manager';
const PROCESS_TYPE_SAAS_REG_GET_DEPENDENCIES     = 'saasRegistryGetDependencies';
const PROCESS_TYPE_SAAS_REG_ON_SUBSCRIPTION      = 'saasRegistryOnSubscription';
const PROCESS_TYPE_SAAS_REG_ON_DEL_SUBSCRIPTION  = 'saasRegistryOnDeleteSubscription';
const PROCESS_TYPE_SMS_GET_DEPENDENCIES          = 'smsGetDependencies';
const PROCESS_TYPE_SMS_ON_SUBSCRIPTION           = 'smsOnSubscription';
const PROCESS_TYPE_SMS_ON_DEL_SUBSCRIPTION       = 'smsOnDeleteSubscription';

module.exports = function (req, res, next) {
  let saasRegistryCredentials = vcapUtils.getServiceCredentials({ label: SAAS_REGISTRY });
  let smsCredentials = vcapUtils.getServiceCredentials({ label: SUBSCRIPTION_MANAGER });

  let subscriptionProcessType = subscriptionUtils.getSubscriptionProcessType(req, saasRegistryCredentials,smsCredentials);
  if (!subscriptionProcessType){
    return next();
  }

  if (subscriptionProcessType === PROCESS_TYPE_SAAS_REG_GET_DEPENDENCIES ||
      subscriptionProcessType === PROCESS_TYPE_SAAS_REG_ON_SUBSCRIPTION  ||
      subscriptionProcessType === PROCESS_TYPE_SAAS_REG_ON_DEL_SUBSCRIPTION){
    subscriptionUtils.checkScopes(req, function (err) {
      if (err) {
        return next(err);
      } else {
        if (subscriptionProcessType === PROCESS_TYPE_SAAS_REG_GET_DEPENDENCIES) {
          subscriptionUtils.getSaaSRegistryDependencies(req, (err, dependencies) => {
            if (err){
              return next(err);
            }
            res.setHeader('Content-Type', 'application/json');
            return res.end(JSON.stringify(dependencies));
          });
        }
        if (subscriptionProcessType === PROCESS_TYPE_SAAS_REG_ON_SUBSCRIPTION) {
          subscriptionUtils.getSaaSRegistryApplicationUrl(req, function (err, url) {
            if (err) {
              return next(err);
            }
            return res.end(url);
          });
        }
        if (subscriptionProcessType === PROCESS_TYPE_SAAS_REG_ON_DEL_SUBSCRIPTION) {
          return res.end();
        }
      }
    });
  }

  if (subscriptionProcessType === PROCESS_TYPE_SMS_GET_DEPENDENCIES ||
      subscriptionProcessType === PROCESS_TYPE_SMS_ON_SUBSCRIPTION  ||
      subscriptionProcessType === PROCESS_TYPE_SMS_ON_DEL_SUBSCRIPTION){
    subscriptionUtils.checkCertificate(req, smsCredentials,function (err) {
      if (err) {
        return next(err);
      } else {
        if (subscriptionProcessType === PROCESS_TYPE_SMS_GET_DEPENDENCIES) {
          subscriptionUtils.getSMSDependencies(req,(err, dependencies) => {
            if (err){
              return next(err);
            }
            res.setHeader('Content-Type', 'application/json');
            return res.end(JSON.stringify(dependencies));
          });
        }
        if (subscriptionProcessType === PROCESS_TYPE_SMS_ON_SUBSCRIPTION) {
          subscriptionUtils.getSMSApplicationUrl(req, smsCredentials,function (err, url) {
            if (err) {
              return next(err);
            }
            return res.end(JSON.stringify(url));
          });
        }
        if (subscriptionProcessType === PROCESS_TYPE_SMS_ON_DEL_SUBSCRIPTION) {
          return res.end();
        }
      }
    });
  }
};