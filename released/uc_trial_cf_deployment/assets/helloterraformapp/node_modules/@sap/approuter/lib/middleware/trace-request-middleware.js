'use strict';

const traceUtil = require('../utils/trace-util');
const passportUtils = require('../passport/utils');
const headerUtil = require('../utils/header-util');
const requestStats = require('request-stats');
const requestTraceEnabled = traceUtil.requestTraceEnabled;

module.exports = function traceRequestMiddleware(req, res, next) {
  const tracer = req.logger;
  const tenantInfo = passportUtils.getTenantInfo(req);
  req.logger.setTenantId(tenantInfo.tenantid);
  req.logger.setTenantSubdomain(tenantInfo.tenant);
  traceUtil.traceIncomingRequest(tracer, req);
  headerUtil.addCorrelationIdHeader(req);
  if (requestTraceEnabled) {
    const logger = req.loggingContext.getLogger('/request/incoming');
    requestStats(req, res, function (stats) {
      if (!stats.ok) {
        logger.info('connection to %s was not closed correctly', stats.req.path);
      }
      logger.info('%s to %s took %d ms to complete with status code %d. %d bytes sent by the client. %d bytes sent back to the client',
        stats.req.method,
        stats.req.path,
        stats.time,
        stats.res.status,
        stats.req.bytes,
        stats.res.bytes);
    });
  }
  next();
};