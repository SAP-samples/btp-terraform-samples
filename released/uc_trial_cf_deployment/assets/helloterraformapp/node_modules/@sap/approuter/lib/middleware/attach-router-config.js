'use strict';

module.exports = function attachRouterConfig(req, res, next) {
  req.routerConfig = req.app.get('mainRouterConfig');
  if (!req.routerConfig.getRouterConfig) {
    return next();
  }
  let startTime = Date.now();
  req.routerConfig.getRouterConfig(req, function(err, customRouterConfig) {
    if (err) { return next(err); }
    traceGetRouterConfig(req.loggingContext, customRouterConfig, startTime);
    req.routerConfig = customRouterConfig || req.routerConfig;
    next();
  });
};

function traceGetRouterConfig(loggingContext, customRouterConfig, startTime) {
  let tracer = loggingContext.getTracer(__filename);
  let time = Date.now() - startTime;
  if (customRouterConfig) {
    tracer.debug('getRouterConfig returned a custom routerConfig in %d ms', time);
  } else {
    tracer.debug('getRouterConfig completed in %d ms without a custom routerConfig', time);
  }
}