'use strict';

const serviceTokenHandler = require('./service-token-handler');
const jwtDecode = require('jwt-decode');
const expiresAt = require('../passport/utils').getExpiresAt;
const businessServiceUtils = require('../utils/business-service-utils');
const sessionExt = require('../utils/session-ext');

module.exports = function (req, res, next) {
  if (!isTokenExchangeRequired(req)) {
    return next();
  }

  shouldAskBusinessToken(req, function(err, askForToken){
    if (err) {
      return next(err);
    }
    if (!askForToken) {
      return next();
    }
    serviceTokenHandler.replaceUserToken(req, null, null, function(err, token) {
      if (process.env.NODE_ENV === 'development') {
        req.session.user = {};
      }
      if (err) { return next(err); }
      let serviceTag   = req.internalUrl.route.service;
      let tokenDecoded = token.access_token ? token : jwtDecode(token);
      let accessToken  = token.access_token ? token.access_token : token;
      sessionExt.update(req.session, function(// eslint-disable-next-line
session) {
        if (!req.session.user.businessServices) {
          req.session.user.businessServices = {};
        }
        req.session.user.businessServices[serviceTag] = {accessToken:  accessToken, expireDate:  expiresAt(tokenDecoded.exp - tokenDecoded.iat).getTime()};
      });
      return next();
    });
  });
};

function isTokenExchangeRequired(req){
  if (req.internalUrl && req.internalUrl.route
      && req.internalUrl.route.service && req.internalUrl.route.credentials
      && businessServiceUtils.getGrantType(req.internalUrl.route.credentials) === 'user_token'){
    return true;
  }
  return false;
}

function shouldAskBusinessToken(req, cb){
  if (process.env.NODE_ENV === 'development') {
    if (req.session) {
      return cb(null, true);
    } else {
      return cb(null, false);
    }
  }

  if (!req.session || !req.session.user){
    return cb(new Error('Route with service needs oauth authentication'));
  }
  let serviceTag = req.internalUrl.route.service;

  if (!req.session.user.businessServices || !req.session.user.businessServices[serviceTag] || req.session.user.businessServices[serviceTag].expireDate < Date.now()) { // no token for current business service or token expired - ask for token
    return cb(null, true);
  }

  return cb(null, false);
}
