'use strict';

const compression = require('compression');
const contentType = require('../utils/content-type');

module.exports = function(conf) {
  let opt = {};
  conf = conf || {};
  opt.threshold = conf.minSize;

  opt.filter = contentType.isResponseContentCompressible;
  const compfnc = function(req, res, next) {
    // WORKAROUND for compression bug/PR https://github.com/expressjs/compression/pull/155 when using http2 - to remove
    req.routerConfig && req.routerConfig.http2Support && (res._implicitHeader = function() {
      // According to https://datatracker.ietf.org/doc/html/rfc9113, remove Connection-Specific Header Fields
      this.removeHeader('transfer-encoding');
      this.removeHeader('proxy-connection');
      this.removeHeader('keep-alive');
      this.removeHeader('upgrade');

      this.writeHead(this.statusCode);
    });
    return compression(opt)(req,res, next);
  };
  return compfnc;
};